**网络层**
* **作用范围**：多个网络
* **任务**：异构网络互联，即跨局域网连接和资源共享，属于通信子网
* **如何完成任务**
  * **软件(协议)**：IP协议，ICMP协议，IGMP协议，ARP协议，路由协议（BGP，RIP，OSPF）
  * **硬件**：路由器（结构，功能）
* **层间关系**：提供给上层尽最大可能交付的传输服务，屏蔽下层的差异（不同局域网的协议）

# 提供什么服务

网络层提供的服务可以是”面向连接“的或是”无连接“的服务。

用于打电话的传统电信网使用**面向连接**的通信方式：它先建立连接预留出网络资源（分组交换中式建立一条虚电路），然后再传送信息，提供的是**可靠传输**的虚电路服务。【逻辑连接，而非像电路交换那样的物理连接】

互联网采用的是**无连接**的方式，发送分组时不需要建立连接。
网络层**向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务**。这样使造价降低，运行灵活。

![pic/虚电路服务和数据报服务](https://image.itbaima.net/images/253/image-2023061518160462.png)

# IPV4

## IP地址

实际上，分类IP地址和划分子网的IP地址已经成为历史，现在用的都是无分类的CIDR

![pic/IP地址编址发展历程](https://image.itbaima.net/images/253/image-20230702165245744.png)

### 分类的IP地址

32位IP地址分为网络号和主机号，网络号位数是固定的

① A类地址：网络号占1个字节，首位固定0。网络号0~127
② B类地址：网络号占2个字节，前两位固定10。网络号128~191
③ C类地址：网络号固定3个字节，前三位固定110。网络号192~223
④ D类地址：多播地址，前四位固定1110。网络号224~239
⑤ E类地址：保留地址，前四位固定1111。网络号240~255

32位地址空间有2^32^个地址。A类有2^31^个地址，占50%；B类有 2^30^个地址，占25%；C类有2^29^个地址，占12.5%。D和E类各占6.5%。

主机号全0表示本主机，主机号全1表示所有主机，因此每类地址最多可指派2^主机号位数^-2个主机

由于全0的网络号表示本网络，网络号127用于回环测试，因此A类地址最多可指派2^8^-2个网络号
![pic/A类网络详解](https://image.itbaima.net/images/253/image-20230702162131118.png)

![pic/B类网络详解](https://image.itbaima.net/images/253/image-20230702165154839.png)

![pic/C类网络详解](https://image.itbaima.net/images/253/image-20230702177201219.png)


### 划分子网的IP地址

32位IP地址分为网络号，子网号，主机号。

### 无分类编制CIDR

32位IP地址分为网络前缀和主机号。网络前缀的**位数不固定**

**网络前缀位数不固定的好处**：按需分配，避免IP地址浪费

用`/`记录网络前缀的位数：如128.14.35.7/20，网络前缀有20位
**具有相同网络前缀的IP地址在同一个网络下**

**地址掩码**：帮助计算机算出IP地址的网络前缀。由一串1或0组成，对应网络前缀的前n位都是1，后面都是0.
>/20 地址掩码：11111111 11111111 11110000 00000000

**查看ip地址是否和网络A在同一个网络**
**人的做法**：知道网络前缀，直接比对，如果网络前缀一样，就是在同一网络里。
**计算机的做法**：IP地址和地址掩码**按位AND**运算，如果结果是网络A的网络前缀，即在同一网络里。

**路由聚合(构造超网)**：对于多个IP地址，找到它们的公共前缀S，将它们合并为一个聚合路由(网络前缀S)。本来路由表要存放多个路由的，现在只用这一个聚合路由代表它们即可。

**最长前缀匹配**
采用CIDR编址，路由表的每个项目由网络前缀和下一跳地址组成，查找时可能得到不止一个匹配结果。这时从匹配结果中选择具有最长网络前缀的路由，因为它更加具体

## ARP协议

负责将目的IP地址转换成目的MAC地址

**大致流程**
① 主机A通过ARP进程在本局域网中广播发送一个ARP请求分组【我的IP是xxx，MAC地址是xxx，我想知道ip地址为XXX的主机的MAC地址】，在本局域网中的所有主机上运行的ARP进程都会收到这个分组

② 若主机B的IP地址与请求分组中要查询的IP一致，则收下该请求分组。向A发送ARP响应分组，并在分组中放入自己的MAC地址。同时，为了以后的方便，将A的IP到MAC地址映射顺便存入自己的ARP缓存中。

③ 其他不匹配的主机不会响应该ARP分组

④ A收到ARP响应分组后，将B的地址映射写入自己的ARP缓存

**使用ARP的四个场景**
(1)发送方是主机H1，把IP数据包发送到本网络上的另一个主机H2。H1发送ARP请求找到目的主机H2的MAC地址。

(2)发送方是主机H1，要把IP数据报发送到另一个网络上的主机H3。H1发送ARP请求，找到本网络上的一个路由器（网关）的MAC地址。剩下的工作由这个路由器来完成。

(3)发送方是路由器，要把IP数据报转发到本网络上的一个主机。路由器发送ARP请求，找到目的主机的MAC地址

(4)发送方是路由器A，要把IP数据报转发到另一个网络的一个主机。路由器A发送ARP请求，找到目标网络上的一个路由器（网关）的MAC地址。剩下的工作有这个路由器来完成。

## IP数据包格式

# 路由器

**路由器**：拥有多输入端口和多输入端口的专用计算机，用于连通不同网络，选择信息传送的线路

**路由器结构**
* 控制平面：负责**路由选择**，即构造路由表
* 数据平面：负责**存储转发**，即根据路由表，构造转发表

![pic/路由器结构](https://image.itbaima.net/images/253/image-20230704162491535.png)

路由表需要对网络拓扑变化的计算最优化，转发表应当试查找过程最优化

后续为了方便，对路由表和转发表不做区分。

# 路由选择

## 分类

**静态路由选择**
由人工配置的网络路由、默认路由、特定主机路由、黑洞路由等都属于静态路由。
* 人工配置方式简单、开销小
* 不能及时适应网络状态 (流量、拓扑等)的变化，一般只在小规模网络中采用

**动态路由选择**
路由器通过路由选择协议自动获取路由信息
* 比较复杂、开销比较大，能较好地适应网络状态的变化
* 适用于大规模网络

**路由选择协议特点**
* 自适应：动态路由选择，能较好地适应网络状态地变化
* 分布式：路由器之间交换路由信息
* 分层次：将整个因特网划分为许多较小的自治系统AS

同一AS中的路由选择称为域内路由选择，采用内部网关(路由)协议IGP
不同AS间的路由选择称为域间路由选择，采用外部网关(路由)协议EGP

![路由选择协议概览.png](https://image.itbaima.net/images/253/image-20231005165013736.png)

## RIP协议

RIP协议属于IGP，是基于距离向量的协议，采用最短路径策略

RIP协议使用`跳数`衡量距离
在RIP中，直连网络的距离为1，其余网络的距离 = `经过的路由器数 - 1`。
由于RIP规定，距离最大不超过16，16表示不可达，因此RIP协议只适合小型互联网

**路由表内容**：包括可达的所有地方
* 目的地址
* 下一跳
* 距离

**构造及更新路由表**
**与相邻路由器交换**各自的路由表，得到相邻路由器的路由表后，对表项中的距离全部加1，然后比对自身的路由表，更新路由表时有以下几种情况：
① 目的地址相同，下一跳相同：旧表项直接更新为最新获得的距离
② 目的地址相同，下一跳不同：如果更新后距离缩短，则更新，否则保持旧值【如果距离相等，有时也会采用等价负载均衡】
③ 自身路由表没有该目的地址：直接将其添加到路由表中

**更新**(**交换路由信息**)**的时机**：周期性，例如30s

**坏消息传播得慢**：路由环路问题【距离向量算法固有问题】
比如有路由器B经过路由器A到达网段C(A、C直连)。
路由器A突然不可达网络C了，对目的地址为C得表项距离设置为16。
但是得到路由器B得路由表后，发现经过B可以到C，距离为2，因此将表项中目的地址为C的距离设置为3
此时B又得到A的路由表，根据更新原则①，B到网段C的距离更新为4
...
一直重复，直到B的路由表中，到网段C的距离为16，才识别出不可达。
![坏消息传播得慢.png](https://image.itbaima.net/images/253/image-20231005164003530.png)


## OSPF协议

属于IGP协议，是基于链路状态的协议，采用最短路径策略

**链路状态**：本路由器与哪些路由器相邻，以及相应链路的“代价”
>“代价”用来表示费用，距离，时延，带宽等等，由网络管理人员来定
>思科路由器中OSPF计算代价：100Mbps/链路带宽，计算结果小于1则记为1，大于1且有小数点则舍去小数

使用OSPF的路由器都会产生链路状态通告**LSA**，包括：
* 直连网络的链路状态信息
* 相邻路由器的链路状态信息

LSA被封装在链路状态更新分组**LSU**中，采用**洪泛法**发送【向系统中所有其他路由器】

使用OSPF的路由器都有一个链路状态数据库**LSDB**，用于存储LSA。通过各路由器发送封装有自己LSA的LSU分组，各路由器的LSDB最终达成一致
可以理解为，一开始，每个路由器都只有各自的地图，经过洪泛后，所有路由器都持有相同的“世界地图”

**构建路由表**
使用OSPF的各路由器基于自身的LSDB进行**最短距离优先SPF算法**，构建出各自到其他路由器的最短路径，即各自的路由表

![OSPF构建路由表.png](https://image.itbaima.net/images/253/image-20231005162215088.png)

**分组类型**

![分组类型.png](https://image.itbaima.net/images/253/image-20231005161878393.png)

**基本工作流程**

![OSPF基本工作流程.png](https://image.itbaima.net/images/253/image-20231005163081381.png)

**多点接入网络中的优化**

![OSPF多点接入网络中的优化.png](https://image.itbaima.net/images/253/image-20231005167681654.png)

**再划分：为了适应更大的网络**
把一个自治系统再划分为若干个更小范围Area，这样，洪泛法的范围从一整个AS缩小为路由器所在的Area
Area划分不应过大，最好不要超过200个路由器
![OSPF再划分.png](https://image.itbaima.net/images/253/image-20231005161496388.png)

## BGP协议

# 分组转发

# ICMP协议

# IPV6

# IP多播

# VPN

# NAT

